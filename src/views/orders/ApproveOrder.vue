<template>
  <v-container>
    <div v-if="loading" class="text-center py-16">
      <v-progress-circular indeterminate color="primary" size="64"></v-progress-circular>
      <p class="mt-4">Carregando dados do pedido...</p>
    </div>

    <v-alert v-else-if="error" type="error" class="mx-auto" max-width="800" prominent>
      {{ error }}
    </v-alert>

    <v-card v-else-if="order" class="glassmorphism-card-approve mx-auto" max-width="800">
      <v-toolbar color="transparent">
        <v-toolbar-title class="font-weight-bold">
          <v-icon start>mdi-check-decagram-outline</v-icon>
          Aprovação de Arte Final
        </v-toolbar-title>
      </v-toolbar>

      <v-card-text class="pa-5">
        <v-row>
          <v-col cols="12" md="6">
            <h3 class="text-h6">Pedido de: {{ order.customer_name }}</h3>
            <v-list density="compact" bg-color="transparent">
              <v-list-item title="Tecido" :subtitle="order.details.fabric_type"></v-list-item>
              <v-list-item title="Metragem" :subtitle="`${order.quantity_meters}m`"></v-list-item>
              <v-list-item title="Status Atual">
                 <template v-slot:subtitle>
                    <v-chip size="small" variant="flat" color="orange">Aguardando Aprovação</v-chip>
                 </template>
              </v-list-item>
            </v-list>
          </v-col>

          <v-col cols="12" md="6">
             <h3 class="text-h6">Arte para Aprovação:</h3>
             <v-card class="mt-2" variant="tonal">
                <v-img
                    v-if="isImage(order.details.final_art_url)"
                    :src="order.details.final_art_url"
                    height="250"
                    cover
                ></v-img>
                 <div v-else class="d-flex flex-column align-center justify-center pa-8" style="height: 250px;">
                    <v-icon size="64">mdi-file-document-outline</v-icon>
                    <p class="mt-2">Arquivo de arte</p>
                 </div>
                 <v-card-actions>
                    <v-btn
                        :href="order.details.final_art_url"
                        target="_blank"
                        block
                        variant="text"
                        color="cyan"
                    >
                        Ver / Baixar Arte Completa
                    </v-btn>
                 </v-card-actions>
             </v-card>
          </v-col>
        </v-row>

        <v-divider class="my-6"></v-divider>

        <div class="d-flex flex-wrap justify-center ga-4">
            <v-btn
                @click="showRequestChangesModal = true"
                color="orange"
                variant="outlined"
                size="large"
                :loading="isSubmitting"
            >
                <v-icon start>mdi-arrow-left</v-icon>
                Solicitar Alteração
            </v-btn>
            <v-btn
                @click="approveAndCreateVhsysOrder"
                color="green"
                variant="flat"
                size="large"
                :loading="isSubmitting"
            >
                 <v-icon start>mdi-check-all</v-icon>
                Aprovar e Faturar no VHSYS
            </v-btn>
        </div>
      </v-card-text>
    </v-card>

    <RequestChangesModal
        :show="showRequestChangesModal"
        :order="order"
        @close="showRequestChangesModal = false"
        @submitted="handleChangesSubmitted"
    />

  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { supabase } from '@/api/supabase';
import { createVhsysOrder } from '@/api/vhsys_api';
import { useUserStore } from '@/stores/user';
import RequestChangesModal from '@/components/RequestChangesModal.vue';

type Order = {
  id: string;
  customer_name: string;
  quantity_meters: number;
  status: string;
  designer_id: string;
  details: {
    stamp_details: string;
    fabric_type: string;
    final_art_url: string;
    vhsys: {
        id_cliente_vhsys: number;
        fantasia_cliente_vhsys: string; // Adicionado
        id_vendedor_vhsys: number;
        razao_vendedor_vhsys: string; // Adicionado
        id_produto_vhsys: number;
        desc_produto_vhsys: string;
        valor_unit_produto: number;
    }
  };
};

const route = useRoute();
const router = useRouter();
const userStore = useUserStore();
const order = ref<Order | null>(null);
const loading = ref(true);
const isSubmitting = ref(false);
const error = ref<string | null>(null);
const showRequestChangesModal = ref(false);
const orderId = route.params.id as string;

const fetchOrderDetails = async () => {
  loading.value = true;
  error.value = null;
  try {
    const { data, error: fetchError } = await supabase.from('orders').select('*').eq('id', orderId).single();
    if (fetchError || !data) throw new Error('Pedido não encontrado.');
    if(data.status !== 'customer_approval') {
        router.push({ name: 'Home' });
        return;
    }
    order.value = data;
  } catch (e: any) { error.value = e.message; }
  finally { loading.value = false; }
};

const isImage = (url: string) => /\.(jpg|jpeg|png|webp|gif|svg)$/i.test(url);

const approveAndCreateVhsysOrder = async () => {
    if (!order.value || !userStore.profile || !order.value.details.vhsys) {
        error.value = "Dados essenciais do pedido ou do VHSYS estão faltando.";
        return;
    }

    const { vhsys_access_token, vhsys_secret_access_token } = userStore.profile;
    if (!vhsys_access_token || !vhsys_secret_access_token) {
        error.value = "As suas credenciais do VHSYS não foram encontradas no seu perfil. Por favor, contate um administrador.";
        return;
    }

    isSubmitting.value = true;
    try {
        const { error: rpcError } = await supabase.rpc('schedule_order_automatically', {
            p_order_id: order.value.id
        });
        if (rpcError) throw rpcError;

        const valorUnitario = order.value.details.vhsys.valor_unit_produto;
        const quantidade = order.value.quantity_meters;
        const valorTotalProduto = valorUnitario * quantidade;

        const vhsysPayload = {
            id_cliente: order.value.details.vhsys.id_cliente_vhsys,
            id_vendedor: order.value.details.vhsys.id_vendedor_vhsys,
            nome_cliente: order.value.details.vhsys.fantasia_cliente_vhsys, // Usa o nome vindo do VHSYS
            nome_vendedor: order.value.details.vhsys.razao_vendedor_vhsys, // Usa o nome vindo do VHSYS
            status_pedido: "Em Aberto",
            valor_total_nota: valorTotalProduto,
            obs_pedido: order.value.details.stamp_details || '',
            produtos: [
                {
                    id_produto: order.value.details.vhsys.id_produto_vhsys,
                    desc_produto: order.value.details.vhsys.desc_produto_vhsys,
                    qtde_produto: quantidade,
                    valor_unit_produto: valorUnitario,
                    valor_total_produto: valorTotalProduto
                }
            ]
        };

        const vhsysResponse = await createVhsysOrder(
            vhsysPayload,
            vhsys_access_token,
            vhsys_secret_access_token
        );

        if (vhsysResponse.data.status !== 'success') {
            throw new Error(`Erro retornado pelo VHSYS: ${JSON.stringify(vhsysResponse.data.data)}`);
        }

        const vhsysOrderId = vhsysResponse.data.data.id_ped;
        console.log(`Pedido ${vhsysOrderId} criado com sucesso no VHSYS!`);

        const updatedDetails = { ...order.value.details, vhsys_order_id: vhsysOrderId };
        await supabase
            .from('orders')
            .update({ details: updatedDetails })
            .eq('id', order.value.id);

        await supabase.from('order_logs').insert({
            order_id: order.value.id,
            profile_id: userStore.profile.id,
            log_type: 'STATUS_CHANGE',
            description: `Arte aprovada. Pedido faturado no VHSYS com o ID: ${vhsysOrderId}.`
        });

        await supabase.from('notifications').insert({
            sender_id: userStore.profile.id,
            content: `Pedido de "${order.value.customer_name}" foi APROVADO e faturado no VHSYS.`,
            redirect_url: '/pedidos'
        });

        router.push({ name: 'Orders' });

    } catch(e: any) {
        alert(`Erro ao aprovar e faturar o pedido: ${e.message}`);
        error.value = `Erro: ${e.message}`;
    } finally {
        isSubmitting.value = false;
    }
};

const handleChangesSubmitted = () => {
    showRequestChangesModal.value = false;
    router.push({ name: 'Home' });
};

onMounted(() => {
  fetchOrderDetails();
});
</script>

<style scoped lang="scss">
.glassmorphism-card-approve {
  backdrop-filter: blur(15px);
  background-color: rgba(25, 25, 30, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
}
</style>
